
model:
  name: parking_lot_model
  nodes:

    - name: ReXNetV1_lite
      alias: rexnet-detection-backbone

    - name: EfficientRep
      alias: efficient-detection-backbone
      params:
        channels_list: [64, 128, 256, 512, 1024]
        num_repeats: [1, 6, 12, 18, 6]
        depth_mul: 0.33
        width_mul: 0.33

    - name: RepPANNeck
      alias: efficient-detection-neck
      inputs:
        - efficient-detection-backbone
      params:
        channels_list: [256, 128, 128, 256, 256, 512]
        num_repeats: [12, 12, 12, 12]
        depth_mul: 0.33
        width_mul: 0.33

    - name: MicroNet
      alias: color-segmentation-backbone

    - name: MobileOne
      alias: brand-segmentation-backbone

    - name: MobileNetV2
      alias: vehicle-type-segmentation-backbone

    - name: ContextSpatial
      alias: context-brand-segmentation-backbone

    - name: EfficientBBoxHead
      alias: bbox-head
      inputs:
        - efficient-detection-neck

    - name: ImplicitKeypointBBoxHead
      alias: car-detection-head
      inputs:
        - rexnet-detection-backbone
      task:
        keypoints: car-keypoints
        boundingbox: car-boundingbox
      params:
        conf_thres: 0.25
        iou_thres: 0.45

    - name: EfficientKeypointBBoxHead
      alias: motorbike-detection-head
      task:
        keypoints: motorbike-keypoints
        boundingbox: motorbike-boundingbox
      inputs:
        - efficient-detection-neck
      params:
        conf_thres: 0.25
        iou_thres: 0.45

    - name: BiSeNetHead
      alias: context-brand-segmentation-head
      task: brand_segmentation
      inputs:
        - context-brand-segmentation-backbone

    - name: SegmentationHead
      alias: color-segmentation-head
      task: color_segmentation
      inputs:
        - color-segmentation-backbone

    - name: SegmentationHead
      alias: any-vehicle-segmentation-head
      task: vehicle_segmentation
      inputs:
        - vehicle-type-segmentation-backbone

    - name: BiSeNetHead
      alias: brand-segmentation-head
      task: brand_segmentation
      inputs:
        - brand-segmentation-backbone

    - name: BiSeNetHead
      alias: vehicle-type-segmentation-head
      task: vehicle_type_segmentation
      inputs:
        - vehicle-type-segmentation-backbone

  losses:
    - name: AdaptiveDetectionLoss
      attached_to: bbox-head
    - name: BCEWithLogitsLoss
      attached_to: any-vehicle-segmentation-head
    - name: CrossEntropyLoss
      attached_to: vehicle-type-segmentation-head
    - name: CrossEntropyLoss
      attached_to: context-brand-segmentation-head
    - name: CrossEntropyLoss
      attached_to: color-segmentation-head
    - name: SoftmaxFocalLoss
      attached_to: brand-segmentation-head
    - name: ImplicitKeypointBBoxLoss
      attached_to: car-detection-head
    - name: EfficientKeypointBBoxLoss
      attached_to: motorbike-detection-head

  metrics:
    - name: ObjectKeypointSimilarity
      attached_to: car-detection-head
    - name: MeanAveragePrecisionKeypoints
      attached_to: motorbike-detection-head
    - name: MeanAveragePrecision
      attached_to: bbox-head
      is_main_metric: true
    - name: F1Score
      attached_to: any-vehicle-segmentation-head
    - name: JaccardIndex
      attached_to: color-segmentation-head
    - name: Accuracy
      attached_to: vehicle-type-segmentation-head
    - name: Precision
      attached_to: brand-segmentation-head
    - name: Recall
      attached_to: context-brand-segmentation-head

  visualizers:
    - name: MultiVisualizer
      alias: multi-visualizer-car
      attached_to: car-detection-head
      params:
        visualizers:
          - name: KeypointVisualizer
            params:
              nonvisible_color: blue
          - name: BBoxVisualizer

    - name: MultiVisualizer
      alias: multi-visualizer-motorbike
      attached_to: motorbike-detection-head
      params:
        visualizers:
          - name: KeypointVisualizer
            params:
              nonvisible_color: blue
          - name: BBoxVisualizer

    - name: SegmentationVisualizer
      alias: color-segmentation-visualizer
      attached_to: color-segmentation-head
    - name: SegmentationVisualizer
      alias: vehicle-type-segmentation-visualizer
      attached_to: vehicle-type-segmentation-head
    - name: SegmentationVisualizer
      alias: vehicle-segmentation-visualizer
      attached_to: any-vehicle-segmentation-head
    - name: SegmentationVisualizer
      alias: context-brand-segmentation-visualizer
      attached_to: context-brand-segmentation-head
    - name: SegmentationVisualizer
      alias: brand-segmentation-visualizer
      attached_to: brand-segmentation-head
    - name: BBoxVisualizer
      alias: bbox-visualizer
      attached_to: bbox-head

tracker:
  project_name: Parking_Lot
  is_tensorboard: True

loader:
  train_view: val
  params:
    dataset_name: D1ParkingLot

trainer:
  accelerator: auto
  devices: auto
  strategy: auto

  num_sanity_val_steps: 1
  profiler: null
  verbose: True
  batch_size: 2
  accumulate_grad_batches: 1
  epochs: 200
  num_workers: 8
  train_metrics_interval: -1
  validation_interval: 10
  num_log_images: 8
  skip_last_batch: True
  log_sub_losses: True
  save_top_k: 3

  preprocessing:
    train_image_size: [256, 320]
    keep_aspect_ratio: False
    train_rgb: True
    normalize:
      active: True
    augmentations:
      - name: Defocus
        params:
          p: 0.1
      - name: Sharpen
        params:
          p: 0.1

  callbacks:
    - name: LearningRateMonitor
      params:
        logging_interval: step
    - name: MetadataLogger
      params:
        hyperparams: ["trainer.epochs", trainer.batch_size]
    - name: ExportOnTrainEnd
    - name: TestOnTrainEnd

